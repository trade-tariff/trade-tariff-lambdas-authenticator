#!/usr/bin/env bash

[[ "$TRACE" ]] && set -o xtrace
set -o errexit
set -o nounset
set -o pipefail
set -o noclobber

declare -A USER_POOL_IDS=(
  ["development"]="eu-west-2_eYCVlIQL0"
  ["staging"]="eu-west-2_h8JF71jvX"
  ["production"]="eu-west-2_dtYQGsKs4"
)

declare -A LOG_LEVELS=(
  ["development"]="DEBUG"
  ["staging"]="INFO"
  ["production"]="WARN"
)

update_config() {
  local stage="$1"
  local user_pool_id="${USER_POOL_IDS[$stage]}"
  local log_level="${LOG_LEVELS[$stage]}"
  local setting
  if [ "$stage" == "production" ]; then
    setting=false
  else
    setting=true
  fi

  jq --arg upid "$user_pool_id" \
     --arg loglevel "$log_level" \
     --argjson rlch "$setting" \
     '.USER_POOL_ID = $upid | .LOG_LEVEL = $loglevel | .RATE_LIMITER_CONFIGURABLE_VIA_HEADER = $rlch' \
     src/config.json > temp.json && mv temp.json src/config.json
}

main() {
  if [ $# -lt 1 ]; then
    echo "Usage: $0 <stage>"
    exit 1
  fi
  export AWS_REGION="us-east-1"
  update_config "$1"
}

main "$@"
